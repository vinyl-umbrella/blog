---
title: Go での高効率で高速な S3 ダウンロードの実装
pubDate: 2025-08-02
description: Go 言語での AWS S3 から大容量ファイルを効率的にダウンロードする方法について．
tags: ['aws', 'go']
---

S3 に大きめのファイルがあるけれども，実行環境のリソース (特にメモリ) に制約がある場合，メモリ不足でダウンロードに失敗することがあります．
ローカル環境では大丈夫だったのに，いざクラウド上で試すとバッチがこけてしまっていたり，想定以上に時間がかかってしまったり，過剰にリソースを消費してしまうことがあります．

これは，`s3.GetObject` で取得したファイル全体をメモリにすべて読み込んでしまっていることがよくある原因です．

実際に Go 言語で S3 から大きなファイルをダウンロードする際のパフォーマンスチューニングを試みました．

## 予備調査

まず，単純な実装である `s3.GetObject` で取得しオブジェクトを丸ごとメモリに乗せる場合，どれくらいのパフォーマンスか調査しました．

実装はこちらにあります．[GitHub](https://github.com/vinyl-umbrella/playground/blob/55b4fd75c5c1505b70d1108e6d8d09e9cd2bfce9/aws/s3go/main.go#L69-L106)

<details open>
<summary>実行環境</summary>

検証に使用した S3 オブジェクトは 1.5 GiB (=1,604,197,053 bytes) です．

**ハードウェアリソース** (結構リッチな構成ですね)

| ジャンル     | スペック                    |
| ------------ | --------------------------- |
| CPU          | Intel Core i5-13500 (6P+8E) |
| メモリ       | 32 GiB (DDR5-5600)          |
| ストレージ   | 1 TB NVMe SSD               |
| ネットワーク | 1 Gbps Ethernet             |

**ソフトウェア**

| ソフトウェア名 | バージョン |
| -------------- | ---------- |
| Linux Distro   | Fedora 41  |
| Linux Kernel   | 6.6.87     |
| Go             | 1.22.4     |

[その他 Go モジュールバージョン](https://github.com/vinyl-umbrella/playground/blob/55b4fd75c5c1505b70d1108e6d8d09e9cd2bfce9/aws/s3go/go.mod)

</details>

### 予備調査結果

パフォーマンス測定には，以下のコマンドを使用しました．

```sh
go test -bench=BenchmarkBadS3GetObject -benchmem -benchtime=1x
```

実行結果は以下の通りです．
| 実行時間 (s) | 総メモリ割当量 (MiB) | アロケーション数 (allocs) |
| ------------ | -------------------- | ------------------------- |
| 120.6 | 1543.1 | 203,067 |

## 実装

AWS SDK for Go では，S3 を扱うための低レベルと高レベルな API が提供されています．
低レベルな API を使うには，`github.com/aws/aws-sdk-go-v2/service/s3` をインポートして使います．ここで先述している `s3.GetObject` のような API を使用可能です．
一方で，高レベルな API は `github.com/aws/aws-sdk-go-v2/feature/s3/manager` にて提供されています．ここでは，並列してオブジェクトをアップロード/ダウンロードするような便利な関数が提供されています．

簡単によりハイパフォーマンスを目指すのであれば，高レベルな API を使うのが良いでしょう．

実際に実装したのがこちらです．[GitHub](https://github.com/vinyl-umbrella/playground/blob/main/aws/s3go/main.go#L21-L42)

特に注目すべきは，このあたりでしょう．(ブログ上で表現するために一部改変しています)
一度に取るサイズや並列数をコントロールするところがポイントです．

```go
downloader := manager.NewDownloader(s3Client, func(d *manager.Downloader) {
    d.PartSize = 10 * 1024 * 1024 // 10 MiB
    d.Concurrency = 4             // 4並列
})

_, err = downloader.Download(ctx, file, &s3.GetObjectInput{
    Bucket: aws.String(bucketName),
    Key:    aws.String(objectKey),
})
```

## パフォーマンス測定・結果

パフォーマンス測定には `go test -bench` を使用します．
ページサイズや並列数を変えて，どのようなパフォーマンスになるかを測定しました．

DocString ではページサイズの最小は 5 MB と記載されています．<cite>[^1]</cite>しかし，それ以下のサイズを指定しても結果に影響が出ることがわかりました．

[^1]: https://github.com/aws/aws-sdk-go-v2/blob/2e08461090ccba679456c05264e2c04bf228138e/feature/s3/manager/download.go#L50

ページサイズ・並列数ともに大きくパフォーマンスに影響を与えることがわかりました．

| ページサイズ | 並列数 | 実行時間 (s) | 総メモリ割当量 (MiB) | アロケーション数 (allocs) |
| ------------ | ------ | ------------ | -------------------- | ------------------------- |
| 512 KiB      | 1      | 226.9        | 269                  | 2,410,394                 |
| 1 MiB        | 1      | 185.1        | 130                  | 1,193,982                 |
| 2 MiB        | 1      | 152.3        | 66.3                 | 645,293                   |
| 5 MiB        | 1      | 128.0        | 27.9                 | 309,246                   |
| 10 MiB       | 1      | 99.2         | 15.1                 | 201,328                   |
| 1 MiB        | 1      | 174.9        | 133                  | 1,195,747                 |
| 1 MiB        | 2      | 104.0        | 131                  | 1,196,784                 |
| 1 MiB        | 4      | 59.3         | 138                  | 1,200,366                 |
| 1 MiB        | 8      | 39.8         | 132                  | 1,208,494                 |
| 1 MiB        | 16     | 30.5         | 133                  | 1,218,981                 |
| 10 MiB       | 16     | 30.4         | 17.6                 | 225,716                   |
| 20 MiB       | 16     | 31.3         | 22.2                 | 283,134                   |
| 50 MiB       | 16     | 32.4         | 7.49                 | 135,138                   |
| 100 MiB      | 16     | 38.0         | 6.30                 | 126,535                   |
| 200 MiB      | 16     | 47.6         | 4.24                 | 107,726                   |

### 余談

<details open>
<summary>s3.GetObject でメモリを確保しなかった場合</summary>

| 実行時間 (s) | 総メモリ割当量 (MiB) | アロケーション数 (allocs) |
| ------------ | -------------------- | ------------------------- |
| 134.0        | 13.1                 | 200,063                   |

これでも十分にメモリ効率は良いが，並列数を上げたほうがさらにダウンロード時間を短縮できます．

[GitHub](https://github.com/vinyl-umbrella/playground/blob/55b4fd75c5c1505b70d1108e6d8d09e9cd2bfce9/aws/s3go/main.go#L68-L106)

 </details>

## まとめ

S3 の大きなオブジェクトのダウンロードでは，`github.com/aws/aws-sdk-go-v2/feature/s3/manager` を使用することをお勧めします．
ページサイズや並列数は使用する環境によって調整が必要だが，ページサイズは大きくするほど，メモリ割当回数が小さくなり，オーバヘッドは小さくなる傾向があります．
並列数も大きくするほど，総メモリ割当量が小さくなる傾向があります．
